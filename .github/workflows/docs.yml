#start

name: Release
on:
  push:
    branches:
      - main
      - develop

jobs:
 buildandpush:
  name: push_file   
  runs-on: ubuntu-latest
  env:
    branch: main
    username: dutchie032
    repo: dutchie032.github.io 
    sourcefileA: Reference
    sourcefileB: GetStarted
  defaults:
   run:
    working-directory: .
  steps:
  - uses: actions/checkout@v4
    with:
      path: './spearhead'
  - name: ls
    run: ls
  - name: Setup credentials to access private repositories
    run: git config --global url.https://${{ secrets.API_TOKEN_GITHUB }}@github.com/.insteadOf https://github.com/
  - name: Git Config
    run: git config --global user.email "automated@action.com"
  - name: Git Config
    run: git config --global user.name "automated action"
  - name: clone
    run: git clone --single-branch --branch $branch https://github.com/$username/$repo 
  - name: ls
    run: ls
  - name: Replace strings in file
    run: | 
      import os
      import datetime

      def replace(fileName, search, replace):
          with open(fileName) as f:
              newText=f.read().replace(search, replace)

          with open(fileName, "w") as f:
              f.write(newText)

      with open("./spearhead/config.lua", "r") as luaFile: 
          luaConfig = luaFile.read()
          replace("./spearhead/_docs/Reference.md", "##!config!##", luaConfig)

      lastUpdateTime = datetime.datetime.now().isoformat()
      replace("./spearhead/_docs/Reference.md", "##!lastupdatetime!##", lastUpdateTime)
      replace("./spearhead/_docs/GetStarted.md", "##!lastupdatetime!##", lastUpdateTime)
    shell: python

  - name: mkdir
    run: mkdir -p ./$repo/Spearhead
  - run: npm i markdown-to-html-cli -g
  - run: markdown-to-html --title 'Spearhead' --dark-mode auto  --keywords "dcs,spearhead,tdcs,mission,campaign,tactical dcs,tactical" --no-dark-mode --markdown-style-theme dark --source ./spearhead/_docs/$sourcefileA.md --output ./$repo/Spearhead/$sourcefileA.html
  - run: markdown-to-html --title 'Spearhead' --dark-mode auto  --keywords "dcs,spearhead,tdcs,mission,campaign,tactical dcs,tactical" --no-dark-mode --markdown-style-theme dark --source ./spearhead/_docs/$sourcefileB.md --output ./$repo/Spearhead/$sourcefileB.html
   
  - run: python3 ./spearhead/SpearheadCompile.py "./spearhead" "./$repo/Spearhead/spearhead.lua"
    if: github.ref == 'refs/heads/main'

  - run: mkdir -p ./$repo/Spearhead/beta
    if: github.ref == 'refs/heads/develop'

  - run: python3 ./spearhead/SpearheadCompile.py "./spearhead" "./$repo/Spearhead/beta/spearhead.lua"
    if: github.ref == 'refs/heads/develop'

  - run: cp -a ./spearhead/_docs/img/. ./$repo/Spearhead/img/
  - name: ls
    run: ls
    working-directory: ./dutchie032.github.io
  - name: add
    run: git add --a
    working-directory: ./dutchie032.github.io
  - name: commit
    run: git commit -a -m "Automatic Update of Spearhead README"
    working-directory: ./dutchie032.github.io
  - name: push
    run: git push
    working-directory: ./dutchie032.github.io